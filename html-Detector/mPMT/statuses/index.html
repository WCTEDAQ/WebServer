<head>
<title>mPMT status page</title>
</head>

<!--#include virtual="/includes/header.html" -->
<!--#include virtual="../subheader.html" -->
<!--#include virtual="/includes/drawer.html" -->

<div id='mpmts' style="width: 800px;"></div>
<div id='mpmt'></div>

<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
<script src='../js/mpmtcommon.js'></script>
<script>

const mpmts = [{"x":6 ,"y":0 ,"s":17,"id": "mPMT-WUT-00051","cid":51 },{"x":7 ,"y":0 ,"s":18,"id": "FD","cid":-1 },{"x":8 ,"y":0 ,"s":19,"id": "mPMT-TRI-00114","cid":114 },{"x":5 ,"y":1 ,"s":16,"id": "FD","cid":-1 },{"x":6 ,"y":1 ,"s":6,"id": "mPMT-WUT-00052","cid":52 },{"x":7 ,"y":1 ,"s":7,"id": "mPMT-TRI-00082","cid":82 },{"x":8 ,"y":1 ,"s":8,"id": "mPMT-TRI-00096","cid":96 },{"x":9 ,"y":1 ,"s":20,"id": "mPMT-TRI-00101","cid":101 },{"x":5 ,"y":2 ,"s":15,"id": "mPMT-WUT-00050","cid":50 },{"x":6 ,"y":2 ,"s":5,"id": "mPMT-TRI-00117","cid":117 },{"x":7 ,"y":2 ,"s":0,"id": "mPMT-TRI-00074","cid":74 },{"x":8 ,"y":2 ,"s":1,"id": "mPMT-WUT-00012","cid":12 },{"x":9 ,"y":2 ,"s":9,"id": "mPMT-WUT-00002","cid":2 },{"x":5 ,"y":3 ,"s":14,"id": "FD","cid":-1 },{"x":6 ,"y":3 ,"s":4,"id": "mPMT-WUT-00046","cid":46 },{"x":7 ,"y":3 ,"s":3,"id": "mPMT-TRI-00108","cid":108 },{"x":8 ,"y":3 ,"s":2,"id": "mPMT-WUT-00027","cid":27 },{"x":9 ,"y":3 ,"s":10,"id": "mPMT-WUT-00011","cid":11 },{"x":6 ,"y":4 ,"s":13,"id": "mPMT-WUT-00047","cid":47 },{"x":7 ,"y":4 ,"s":12,"id": "FD","cid":-1 },{"x":8 ,"y":4 ,"s":11,"id": "mPMT-TRI-00094","cid":94 },{"x":0 ,"y":5 ,"s":21,"id": "mPMT-WUT-00045","cid":45},{"x":1 ,"y":5 ,"s":22,"id": "mPMT-TRI-00102","cid":102},{"x":2 ,"y":5 ,"s":23,"id": "mPMT-TRI-00077","cid":77},{"x":3 ,"y":5 ,"s":24,"id": "mPMT-TRI-00100","cid":100},{"x":4 ,"y":5 ,"s":25,"id": "mPMT-TRI-00092","cid":92},{"x":5 ,"y":5 ,"s":26,"id": "mPMT-TRI-00113","cid":113},{"x":6 ,"y":5 ,"s":27,"id": "Empty","cid":-1},{"x":7 ,"y":5 ,"s":28,"id": "mPMT-TRI-00083","cid":83},{"x":8 ,"y":5 ,"s":29,"id": "mPMT-WUT-00017","cid":17},{"x":9 ,"y":5 ,"s":30,"id": "mPMT-TRI-00080","cid":80},{"x":10 ,"y":5 ,"s":31,"id": "mPMT-TRI-00073","cid":73},{"x":11 ,"y":5 ,"s":32,"id": "Empty","cid":-1},{"x":12 ,"y":5 ,"s":33,"id": "mPMT-TRI-00078","cid":78},{"x":13 ,"y":5 ,"s":34,"id": "mPMT-WUT-00007","cid":7},{"x":14 ,"y":5 ,"s":35,"id": "mPMT-TRI-00112","cid":112},{"x":15 ,"y":5 ,"s":36,"id": "mPMT-TRI-00079","cid":79},{"x":0 ,"y":6 ,"s":37,"id": "mPMT-WUT-00048","cid":48},{"x":1 ,"y":6 ,"s":38,"id": "mPMT-TRI-00105","cid":105},{"x":2 ,"y":6 ,"s":39,"id": "mPMT-WUT-00006","cid":6},{"x":3 ,"y":6 ,"s":40,"id": "mPMT-TRI-00104","cid":104},{"x":4 ,"y":6 ,"s":41,"id": "mPMT-WUT-00019","cid":19},{"x":5 ,"y":6 ,"s":42,"id": "mPMT-TRI-00095","cid":95},{"x":6 ,"y":6 ,"s":43,"id": "mPMT-WUT-00044","cid":44},{"x":7 ,"y":6 ,"s":44,"id": "mPMT-TRI-00107","cid":107},{"x":8 ,"y":6 ,"s":45,"id": "Empty","cid":-1},{"x":9 ,"y":6 ,"s":46,"id": "mPMT-WUT-00036","cid":36},{"x":10 ,"y":6 ,"s":47,"id": "mPMT-WUT-00023","cid":23},{"x":11 ,"y":6 ,"s":48,"id": "mPMT-WUT-00039","cid":39},{"x":12 ,"y":6 ,"s":49,"id": "mPMT-WUT-00041","cid":41},{"x":13 ,"y":6 ,"s":50,"id": "mPMT-WUT-00029","cid":29},{"x":14 ,"y":6 ,"s":51,"id": "mPMT-WUT-00043","cid":43},{"x":15 ,"y":6 ,"s":52,"id": "mPMT-WUT-00030","cid":30},{"x":0 ,"y":7 ,"s":53,"id": "mPMT-WUT-00014","cid":14},{"x":1 ,"y":7 ,"s":54,"id": "mPMT-WUT-00031","cid":31},{"x":2 ,"y":7 ,"s":55,"id": "mPMT-TRI-00118","cid":118},{"x":3 ,"y":7 ,"s":56,"id": "mPMT-WUT-00028","cid":28},{"x":4 ,"y":7 ,"s":57,"id": "mPMT-TRI-00115","cid":115},{"x":5 ,"y":7 ,"s":58,"id": "mPMT-WUT-00015","cid":15},{"x":6 ,"y":7 ,"s":59,"id": "mPMT-WUT-00009","cid":9},{"x":7 ,"y":7 ,"s":60,"id": "mPMT-WUT-00026","cid":26},{"x":8 ,"y":7 ,"s":61,"id": "mPMT-WUT-00010","cid":10},{"x":9 ,"y":7 ,"s":62,"id": "mPMT-WUT-00025","cid":25},{"x":10 ,"y":7 ,"s":63,"id": "mPMT-TRI-00119","cid":119},{"x":11 ,"y":7 ,"s":64,"id": "mPMT-WUT-00021","cid":21},{"x":12 ,"y":7 ,"s":65,"id": "mPMT-WUT-00038","cid":38},{"x":13 ,"y":7 ,"s":66,"id": "mPMT-TRI-00106","cid":106},{"x":14 ,"y":7 ,"s":67,"id": "mPMT-WUT-00013","cid":13},{"x":15 ,"y":7 ,"s":68,"id": "mPMT-WUT-00003","cid":3},{"x":0 ,"y":8 ,"s":69,"id": "mPMT-WUT-00018","cid":18},{"x":1 ,"y":8 ,"s":70,"id": "mPMT-WUT-00001","cid":1},{"x":2 ,"y":8 ,"s":71,"id": "mPMT-WUT-00024","cid":24},{"x":3 ,"y":8 ,"s":72,"id": "mPMT-WUT-00040","cid":40},{"x":4 ,"y":8 ,"s":73,"id": "mPMT-WUT-00016","cid":16},{"x":5 ,"y":8 ,"s":74,"id": "Empty","cid":-1},{"x":6 ,"y":8 ,"s":75,"id": "mPMT-WUT-00032","cid":32},{"x":7 ,"y":8 ,"s":76,"id": "mPMT-WUT-00035","cid":35},{"x":8 ,"y":8 ,"s":77,"id": "Empty","cid":-1},{"x":9 ,"y":8 ,"s":78,"id": "mPMT-WUT-00034","cid":34},{"x":10 ,"y":8 ,"s":79,"id": "Empty","cid":-1},{"x":11 ,"y":8 ,"s":80,"id": "mPMT-WUT-00042","cid":42},{"x":12 ,"y":8 ,"s":81,"id": "mPMT-WUT-00020","cid":20},{"x":13 ,"y":8 ,"s":82,"id": "mPMT-WUT-00022","cid":22},{"x":14 ,"y":8 ,"s":83,"id": "mPMT-WUT-00033","cid":33},{"x":15 ,"y":8 ,"s":84,"id": "mPMT-WUT-00008","cid":8},{"x":6 ,"y":9 ,"s":102,"id": "mPMT-TRI-00081","cid":81},{"x":7 ,"y":9 ,"s":103,"id": "mPMT-TRI-00071","cid":71},{"x":8 ,"y":9 ,"s":104,"id": "mPMT-TRI-00109","cid":109},{"x":5 ,"y":10 ,"s":101,"id": "mPMT-TRI-00093","cid":93},{"x":6 ,"y":10 ,"s":91,"id": "Empty","cid":-1},{"x":7 ,"y":10 ,"s":92,"id": "mPMT-TRI-00097","cid":97},{"x":8 ,"y":10 ,"s":93,"id": "mPMT-TRI-00085","cid":85},{"x":9 ,"y":10 ,"s":105,"id": "mPMT-TRI-00086","cid":86},{"x":5 ,"y":11 ,"s":100,"id": "mPMT-TRI-00098","cid":98},{"x":6 ,"y":11 ,"s":90,"id": "mPMT-TRI-00099","cid":99},{"x":7 ,"y":11 ,"s":85,"id": "Empty","cid":-1},{"x":8 ,"y":11 ,"s":86,"id": "mPMT-TRI-00076","cid":76},{"x":9 ,"y":11 ,"s":94,"id": "mPMT-TRI-00091","cid":91},{"x":5 ,"y":12 ,"s":99,"id": "Empty","cid":-1},{"x":6 ,"y":12 ,"s":89,"id": "mPMT-TRI-00089","cid":89},{"x":7 ,"y":12 ,"s":88,"id": "mPMT-TRI-00087","cid":87},{"x":8 ,"y":12 ,"s":87,"id": "mPMT-TRI-00084","cid":84},{"x":9 ,"y":12 ,"s":95,"id": "mPMT-TRI-00075","cid":75},{"x":6 ,"y":13 ,"s":98,"id": "mPMT-TRI-00103","cid":103},{"x":7 ,"y":13 ,"s":97,"id": "mPMT-TRI-00111","cid":111},{"x":8 ,"y":13 ,"s":96,"id": "mPMT-TRI-00110","cid":110}]

function id_to_short(n) {
    if (n.toUpperCase().startsWith("MPMT")) {
        return n.split("-")[2];
    } 
    return n;
}

/*
 Statuses: 0 - unknown - blue rgb(2, 119, 189)
    1 - ok, no HV - greenyellow rgb(175, 180, 43)
    2 - ok, HV on - green rgb(46, 125, 50)
    3 - minor ptoblems orange rgb(230, 74, 25)
    4 - major problems red rgb(238, 0, 7)
    5 - stale info purple rgb(194, 24, 91)
*/

function id_and_status_to_colors(n,s) {
    if (n.toUpperCase().startsWith("MPMT")) {
        switch(s) {
            case 1: return ['rgb(175, 180, 43)','rgba(175, 180, 43, 0.5)'];
            case 2: return ['rgb(46, 125, 50)','rgba(46, 125, 50, 0.5)'];
            case 3: return ['rgb(230, 74, 25)','rgba(230, 74, 25, 0.5)'];
            case 4: return ['rgb(238, 0, 7)','rgba(238, 0, 7, 0.5)'];
            case 5: return ['rgb(210, 89, 136)','rgba(210, 89, 136, 0.5)'];
            case 9: return ['rgb(252, 252, 3)','rgba(252, 252, 3, 0.5)'];
        }
        return ['rgb(2, 119, 189)','rgba(2, 119, 189, 0.5)'];
    }
    if (n.toUpperCase()=="FD") {
        return ['rgb(82, 28, 115)','rgba(82, 28, 115, 0.5)']
    }
    if (n.toUpperCase()=="EMPTY") {
        return ['rgb(117, 117, 117)','rgba(117, 117, 117, 0.5)']
    }
}

function status_from_table(status_table, cid) {
    if (cid==-1)
        return 0;
    e = status_table.find((v) => {return v.cid==cid;});
    if (e) {
        return e.status;
    }
    return 0;
}


function do_plot(status_table,handler) {

    var layout = {

    title: 'MPMT View',
    xaxis: {
        range: [0, 16],
        showgrid: false,
        zeroline: false,
        showticklabels: false,
    },

    yaxis: {
        range: [0, 14],
        showgrid: false,
        zeroline: false,
        showticklabels: false,
    },

    width: 1600,
    height: 1400,
    showlegend: false,
    hovermode: 'closest',
    layer: 'below',
    shapes: [],
    }

    var d_x = [], d_y = [], d_t = [], d_t1 = [];

    for (x = 0; x < 16; x++)
        for (y = 0; y<14; y++) {        
            exists = mpmts.find((m)=>{ return m.x==x && m.y==y})
            if (exists) {
                d_x.push(x+.5);
                d_y.push(y+.5);
                d_t.push(id_to_short(exists['id']));
                d_t1.push(`${exists['s']}`);
                c = id_and_status_to_colors(exists['id'],status_from_table(status_table,exists['cid']));
                layout.shapes.push({
                    type: 'path',
                    fillcolor: c[1],
                    line: {
                        color: c[0]
                    },
                    path: `M ${x+0.05} ${y+0.33} L ${x+0.33} ${y+0.05} L ${x+0.66} ${y+0.05} L ${x+0.95} ${y+0.33} L ${x+0.95} ${y+0.66} L ${x+0.66} ${y+0.95} L ${x+0.33} ${y+0.95} L ${x+0.05} ${y+0.66}  Z`,
                });
            }
        }

    const legend = [
        {"n": "mPMT, unknown state", "c": id_and_status_to_colors("mPMT",0)},
        {"n": "mPMT, ok, no HV", "c": id_and_status_to_colors("mPMT",1)},
        {"n": "mPMT, ok, HV on", "c": id_and_status_to_colors("mPMT",2)},
        {"n": "mPMT, minor problem", "c": id_and_status_to_colors("mPMT",3)},
        {"n": "mPMT, major problem", "c": id_and_status_to_colors("mPMT",4)},
        {"n": "mPMT, stale information", "c": id_and_status_to_colors("mPMT",5)},
        {"n": "mPMT, firmware done, just info", "c": id_and_status_to_colors("mPMT",9)},
        {"n": "Far detector", "c": id_and_status_to_colors("FD",0)},
        {"n": "Empty slot", "c": id_and_status_to_colors("Empty",0)},
    ];

    var yy = 10.0, xx = 12.0, l_x = [], l_y = [], l_t = [];

    legend.forEach((l) => {
        layout.shapes.push({
            type: 'path',
            fillcolor: l.c[1],
            line: {
                color: l.c[0]
            },
            path: `M ${xx} ${yy+0.05} L ${xx+3} ${yy+0.05} L ${xx+3} ${yy+0.35} L ${xx} ${yy+0.35} Z`,
        });
        l_x.push(xx+1.5);
        l_y.push(yy+0.2);
        l_t.push(l.n);
        yy += 0.4;    
    });


    var plotdata = [{
    x: d_x,
    y: d_y,
    mode: 'text',
    text: d_t1,
    textposition: 'top_center',
    type: 'scatter',
    hoverinfo: 'skip',
    textfont: {
        color: 'rgb(0,0,0)',
        size: 12,
        weight: 100,
    }
    },
    {
    x: d_x,
    y: d_y,
    mode: 'text',
    text: d_t,
    textposition: 'bottom_center',
    type: 'scatter',
    hoverinfo: 'skip',
    textfont: {
        color: 'rgb(0,0,0)',
        size: 16,
        weight: 200,
    }
    },
    {
    x: l_x,
    y: l_y,
    mode: 'text',
    text: l_t,
    textposition: 'middle_center',
    type: 'scatter',
    hoverinfo: 'skip',
    textfont: {
        color: 'rgb(0,0,0)',
        size: 16,
        weight: 200,
    }
    },
    {
    x: d_x,
    y: d_y,
    mode: 'markers',
    type: 'scatter',    
    hoverinfo: 'none',
    marker: { size: 1,
    opacity: 0.01 }
    }];

    Plotly.newPlot('mpmts', plotdata, layout);

    var plot = document.getElementById('mpmts');
    
    plot.on('plotly_click', function(data){
        if (data.event.button==0 && data.points.length>0) {            
            x = data.points[0].x;
            y = data.points[0].y;
            exists = mpmts.find((m)=>{ return Math.abs(m.x+0.5-x)<0.45 && Math.abs(m.y+0.5-y)<0.45});
            if (exists && exists['id'].toUpperCase().startsWith("MPMT")) {                
                if (handler) {
                    handler(exists);
                }
            }            
        }        
    });
}

function handle_click(mpmt) {
    var e = document.getElementById('mpmt');
    e.innerHTML = spinner(`Loading data for ${mpmt['cid']}`);

}


// use like: [{'cid':9, 'status': 1},{'cid':26, 'status': 2},{'cid':119, 'status': 3},{'cid':117, 'status': 4},{'cid':118, 'status': 5}]
do_plot([
    {'cid':45, 'status': 9},
    {'cid':7, 'status': 9},
    {'cid':92, 'status': 9},
    {'cid':107, 'status': 9},
    {'cid':26, 'status': 9},
    {'cid':118, 'status': 9},
    {'cid':13, 'status': 9},
    {'cid':42, 'status': 9},
    {'cid':21, 'status': 9},
    {'cid':34, 'status': 9},
    {'cid':99, 'status': 9},
    {'cid':12, 'status': 9},
    {'cid':40, 'status': 9},
    {'cid':85, 'status': 9},
    {'cid':46, 'status': 9},
    {'cid':52, 'status': 9},
    {'cid':15, 'status': 9},
    {'cid':14, 'status': 9},
    {'cid':110, 'status': 9},
    {'cid':94, 'status': 9},
    {'cid':103, 'status': 9},
    {'cid':77, 'status': 9},
    {'cid':93, 'status': 9},
    {'cid':73, 'status': 9},
    {'cid':8, 'status': 9},
    {'cid':36, 'status': 9},
    {'cid':104, 'status': 9},
    {'cid':32, 'status': 9},
    {'cid':105, 'status': 9},
    {'cid':71, 'status': 9},
    {'cid':41, 'status': 9},
],handle_click);

</script>

<!--#include virtual="/includes/footer.html" -->
